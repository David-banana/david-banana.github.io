<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Core"><title>容器化升级对服务有哪些影响 · David Cai</title><meta name="description" content="容器化升级对服务有哪些影响？容器技术是近几年计算机领域的热门技术，特别时随着各种云服务的发展，越来越多的服务运行在以Docker为代表的容器之内。
这一课时我们就来分享一下容器化技术相关的知识
容器化技术简介相比于传统虚拟化技术，容器技术是一种更加轻量级的操作系统隔离方案，可以将应用程序及其运行依赖"><meta name="keywords" content="大大卫的博客"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 5.0.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">David Cai</a></h3><div class="description"><p>心之所愿，无事不成。<br> Nothing is impossible to a willing heart.</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/David-banana"><i class="fa fa-github"></i></a></li><li><a href="caidaweigo@163.com"><i class="fa fa-envelope"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2019 - 2020 </span><i class="fa fa-star"></i><span> Core</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/mrcore/hexo-theme-Anatole-Core" target="_blank">Anatole-Core.  </a><a href="http://www.beian.miit.gov.cn/" target="_blank">&nbsp;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/guestbook">留言</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>容器化升级对服务有哪些影响</a></h3></div><div class="post-content"><h4 id="容器化升级对服务有哪些影响？"><a href="#容器化升级对服务有哪些影响？" class="headerlink" title="容器化升级对服务有哪些影响？"></a>容器化升级对服务有哪些影响？</h4><p>容器技术是近几年计算机领域的热门技术，特别时随着各种云服务的发展，越来越多的服务运行在以Docker为代表的容器之内。</p>
<p>这一课时我们就来分享一下容器化技术相关的知识</p>
<h4 id="容器化技术简介"><a href="#容器化技术简介" class="headerlink" title="容器化技术简介"></a>容器化技术简介</h4><p>相比于传统虚拟化技术，容器技术是一种更加轻量级的操作系统隔离方案，可以将应用程序及其运行依赖环境打包到镜像中，通过容器引擎进行调度，并且提供进程隔离和资源限制运行环境。</p>
<p><strong>虚拟化技术</strong></p>
<p>虚拟化技术通过Hypervisor实现虚拟机与底层硬件的解耦，虚拟机实现依赖Hypervisor层，Hypervisor是整个虚拟机的核心所在。</p>
<p>Hypervisor是什么呢？也可以叫做虚拟机监视器VMM（Virtual Machine Monitor），是一种运行的基础物里服务器和操作系统之间的中间软件层，可允许多个操作系统和应用共享硬件。</p>
<p><img src="/2020-6-10-Container%20Update/CgqCHl7WGTGAYIMiAAEsU7_CGq0092.png" alt="CgqCHl7WGTGAYIMiAAEsU7_CGq0092"></p>
<p>Hypervisor虚拟机可以模拟机器硬件资源，协调虚拟机对硬件资源的访问，同时在各个虚拟机之间进行隔离。</p>
<p>每一个虚拟机都包括执行的应用，依赖的二进制和库资源，以及一个完整的OS操作系统，虚拟机运行以后，预分配给它的资源将全部被占用。</p>
<h4 id="容器化技术"><a href="#容器化技术" class="headerlink" title="容器化技术"></a>容器化技术</h4><p>在容器技术中，最具代表性且应用最广泛的时Docker技术。</p>
<p>Docker是一个开源的应用容器引擎，可以打包应用以及依赖包到一个可移植的容器中，然后发布到服务器上，Docker容器基于镜像运行，可部署在物理机或虚拟机上，通过容器编排调度平台实现容器化应用的生命周期管理。</p>
<p>使用容器化技术有哪些好处呢？</p>
<p>Docker不同于VM，只包含应用程序及依赖库，处于一个隔离的环境中，这使得Docker更加清凉高效，启动容器只需要几秒钟才能完成，由于Docker轻量，资源占用少，可以更方便的部署标准化应用，一台主机可以同时运行上千个Docker容器。</p>
<h4 id="两种虚拟化技术的对比？"><a href="#两种虚拟化技术的对比？" class="headerlink" title="两种虚拟化技术的对比？"></a>两种虚拟化技术的对比？</h4><p>虚拟机是一个运行在宿主机之上的完整操作系统，虚拟机运行自身操作系统会占用较多的CPU、内存、硬盘资源等。</p>
<p>虚拟化技术用户提供了一个完整的虚拟机，包括操作系统在内，容器化技术为应用程序提供了隔离的运行空间，容器之间共享同一个上层操作系统内核。虚拟化技术有更佳的隔离性和安全性，但是更新和升级困难，容器化具有快速扩展，灵活性和易用性等优势，但其隔离性较差，安全性较低。</p>
<p>实际部署一般是把两种技术结合起来，比如 一个虚拟机中运行多个容器，这样既保证了较好的强隔离性和安全性，也有了快速发展、灵活性和易用性。</p>
<h4 id="容器化的原理"><a href="#容器化的原理" class="headerlink" title="容器化的原理"></a>容器化的原理</h4><p>容器技术的核心是如何实现容器内资源的限制，以及不同容器之间的隔离，这些是基于Linux的Namespace和CGroups技术。</p>
<p><img src="/2020-6-10-Container%20Update/Ciqc1F7WGUmActLFAALf3E5436Y591.png" alt="Ciqc1F7WGUmActLFAALf3E5436Y591"></p>
<h4 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h4><p>Namespace的目的是通过抽象方法是的Namespace中的进程看起来拥有它们自己的隔离的全局系统资源实例。</p>
<p> Linux内核实现了六种Namespace： Mount namespaces、UTS namespaces、IPC namespaces、PID namespaces、Network namespaces、User namespaces，功能分别为：隔离文件系统、定义hostname和domainame、特定的进程间通信资源、独立进程ID结构，独立网络设备、用户和组ID空间。</p>
<p>Docker在创建一个容器的时候，会创建以上六种Namespace实例，然后将隔离的系统资源放入到相应的Namespace中，使得每个容器只能看到自己独立的系统资源</p>
<h4 id="Cgroups"><a href="#Cgroups" class="headerlink" title="Cgroups"></a>Cgroups</h4><p>Docker利用CGroups进行资源隔离。CGroups（Control Groups）也是Linux内核中提供的一种机制，它的功能主要是限制、记录、隔离进程所使用的物理资源，比如CPU、Memory、IO、Network等。</p>
<p>简单来说，CGroups在接受到调用时，会给指定的进程挂上钩子，这个钩子会在资源被使用的时候触发，触发时会根据资源的类别，比如CPU、Mermory、IO等，然后使用对应的方法进行限制。</p>
<p>CGroup中有一个术语叫做Subsystem子系统，也就是一个资源调度控制器，CPU Subsystem负责CPU的时间分配，Mermory Subsystem负责Mermory的使用量等，Docker启动一个容器后，会在/sys/fs/cgroup目录下生成带有此容器ID的文件夹，里面就是调用CGroup的配置文件，从而实现通过CGroup限制容器的资源使用率。</p>
<h4 id="微服务如何适配容器化"><a href="#微服务如何适配容器化" class="headerlink" title="微服务如何适配容器化"></a>微服务如何适配容器化</h4><p>微服务的设计思想是对系统功能进行解耦，拆分为单独的服务，可以独立运行，而容器进一步对这种解耦性进行了扩展，应用容器技术可以对服务进行快速水平扩展，从而到达弹性部署业务的能力。在各种云服务概念兴起之后，微服务结合 Docker 部署，更加方便微服务架构运维部署落地。</p>
<p>微服务结合容器有很多优点，但是另一方面，也给服务的部署和应用提出了一些新的问题。</p>
<p>以 Java 服务为例，容器与虚拟机不同，其资源限制通过 CGroup 来实现，而容器内部进程如果不感知 CGroup 的限制，就进行内存、CPU 分配的话，则可能会导致资源冲突的问题。</p>
<p>Java 8 之前的版本无法跟 Docker 很好的配合，JVM 通过容器获取的可用内存和 CPU 数量并不是 Docker 允许使用的可用内存和 CPU 数量。</p>
<p>我们在开发中会应用一些线程池，通常会根据 CPU 核心数来配置，比如使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().availableProcessors()</span><br></pre></td></tr></table></figure>

<p>在 1.8 版本更早的实现，在容器内获取的是上层物理机或者虚拟机的 CPU 核心数，这就使得线程池配置不符合我们期望的设置。</p>
<p>另一个影响体现在 GC 中，JVM 垃圾对象回收对 Java 程序执行性能有一定的影响，默认的 JVM 使用公式“ParallelGCThreads = (ncpus &lt;= 8) ? ncpus : 3 + ((ncpus * 5) / 8)” 来计算并行 GC 的线程数，其中 ncpus 是 JVM 发现的系统 CPU 个数。如果 JVM 应用了错误的 CPU 核心数，会导致 JVM 启动过多的 GC 线程，导致 GC 性能下降，Java 服务的延时增加。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=69#/detail/pc?id=1913">分布式技术原理与实战45讲</a></p>
</blockquote>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-06-10</span><i class="fa fa-tag"></i><a class="tag" href="/categories/Technology-blog/" title="Technology blog">Technology blog </a><a class="tag" href="/tags/技术笔记/" title="技术笔记">技术笔记 </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://yoursite.com/2020-6-10-Container Update/,David Cai,容器化升级对服务有哪些影响,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2020-6-13-guaduate2.0/" title="毕业照2.0！">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020-6-9-graduate1.0/" title="毕业照1.0！">下一篇</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>